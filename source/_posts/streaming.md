---
title: Data Streaming at Scale in Azure
categories: [Data]
tags: [messaging, eventing, events, data streaming, streams]
date: 2019-08-28
---

## Overview
Many modern enterprise applications start with data generated by real world events like human interactions or regular sensor readings, and it's often the modern developer's job to design a system that will capture that data, move it quickly through some data pipeline, and then turn it into real insights that help the enterprise make decisions to improve business.

I'm going to generalize and call this concept _data streaming_. I'll focus on _streaming_ and will not cover things like _data persistence_ or _data analysis_. I'm talking about the services that facilitate getting and keeping your data moving and performing operations on it while it's in transit.

Data streaming is an extremely common solution component, and there's a myriad of software services that exist to fulfill it. In fact, there are so many tools, that it's often difficult to know where to start. But fear not. The whole point of this article is to introduce you to Azure's data streaming services.

## Datagrams
When you're streaming data, the payload is up to you. It might be very small like a heartbeat or very large like an entire blob. Often, streaming data is made up of _messages_ or _events_. In this article, I'll use the term _datagram_ (lifted from Clemens Vasters' [article](https://azure.microsoft.com/en-us/blog/events-data-points-and-messages-choosing-the-right-azure-messaging-service-for-your-data/)) to refer abstractly to any payload whether you would consider it a message or an event.

![](/files/streaming_01.png "datagrams")

What exactly is the difference between an _event_ and a _message_. The official Azure documentation contains an article called [Choose between Azure messaging services - Event Grid, Event Hubs, and Service Bus](https://docs.microsoft.com/en-us/azure/event-grid/compare-messaging-services) that does a great job with explaining this, so read that first, and then here's my take.

An event is a bit like a system level notification. You and I get notifications on our mobile devices because we want to know what's going on, right?

 * The battery level just dropped to 15%. I want to know that so I can plug it in.

 * I just got a text message from Terry. I've been waiting to hear from her, so that's significant.

 * Somebody outbid me on that auction item. I need to consider raising my bid.

I might want events to be raised even if I don't plan to respond to them right away too, because I might want to go back and study all of those events over time to make sense of them.

A set of events over time looks a bit like a history book, doesn't it? You could react in real time as events occur, or you could get a list of all of last week's events and you could essentially replay the entire week. Or you could do both! 

![](/files/streaming_05.png "events history book")

The battery level event example I brought up is a pretty simply event, right? Sometimes, however, events are more complicated and domain-specific, like "Your battery level is 5% less than your average level this time of day." That kind of event takes some state tracking and data analysis. It's really helpful though.

This is what I call _cascading events_. The first-level events are somewhat raw - mostly just sensor readings or low-level events that have fired. The next level is some fusion or aggregation of those events that's higher level and often times more meaningful to an end user or business user - what we might call _domain events_. And, of course, events can cascade past 2 levels, and at the last level, it's common to raise a notification - on a mobile device, a dashboard, or an email inbox.

Messages are different though.

Messages are more self-contained packages that relay some unit of information or a command complete with the details of that command.

I used the analogy of a history book to describe all of last week's *events*. I suppose all of last week's messages would be more like a playbook or a transaction log. Notice that my sample *messages* are more *present tense* and *directive*. That's fairly typical for messages.

![](/files/streaming_06.png "messages play book")

One of the defining characteristics of a message is that there is a coupling between the message producer and the consumer - that is, the producer has some expectation or even reliance on what the consumer will do with it. Clemens rightly [states](https://azure.microsoft.com/en-us/blog/events-data-points-and-messages-choosing-the-right-azure-messaging-service-for-your-data/) that with events "the coupling is very loose, and removing these consumers doesn’t impact the source application’s functional integrity". So, I can use that as a test. If I stop subscribing to the produced datagrams, will something break? If so, you're dealing with messages as opposed to events.

## Data Streaming Services in Azure
Let's start with Azure's data streaming services.

### Storage Queues
Not to be confused with _Service Bus_ Queues, Azure's Storage Queues are perhaps the most primitive and certainly the oldest queue structure available.

In case you're not familiar with the core concept of a queue, it would be good to explain that. A queue is a data structure that follows a _first-in first-out_ (FIFO) access pattern - meaning that if you put Thing A, Thing B, and then Thing C in (in that order), and then you ask the queue for its next item, it will give you Thing A - first in... first out.

![](/files/streaming_02.png "queue")

If you studied computer science and you weren't sleeping during your _Data Structures_ class, then you already know about queues.

Queues are extremely handy in cloud-first applications where it's common to use one working process to set aside tasks for one or more other working processes to pick up and fulfill.

Storage Queues are not as robust as some of the other data streaming services in Azure, but sometimes they are simply all you need. Also, they're delightfully inexpensive.

### Service Bus Queues
Service Bus Queues are newer and far more robust than Storage Queues. There are some significant advantages including the ability to guarantee message ordering (there are some edge cases where Storage can get messages out of order), role-based access, the use of the AMQP protocol instead of just HTTP, and extensibility.

To study the finer differences between Storage Queues and Service Bus Queues, read [Storage queues and Service Bus queues - compared and contrasted](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted).

### Service Bus Topics
Queues are the solution when you want one and only one worker to take a message out of the queue and process it. Think about incoming pizza orders where multiple workers are tasked with adding toppings. If one worker puts the anchovies on a pizza then it's done, and the other workers should leave it alone.

Topics are quite different. Topics are the solution when you have messages that are occurring and one _or more_ parties are interested. Think about a magazine subscription where it's produced one time, but multiple people want to receive a copy. You often hear this referred to as a "publish/subscribe" pattern or simply "pubsub". In this case, messages are pushed into a _topic_ and zero to many parties are registered as being interested in that topic. Whenever a new messages lands, the interested parties are notified and can do their processing.

You'll hear the semantics _At Most Once_, _At Least Once_, and _Exactly Once_. These are nuances in the behavior of data streaming services and how they handle edge cases such as when a service goes down while a message is in processing.


(particulars on peeking, locking, deadlettering, etc.)

### Event Hubs
Now let's take another view on processing data and look at _events_ instead of _messages_.

Event Hub is Azure's solution for facilitating massive scale event processing. It's ability to get data into Azure is staggering. The [feature page](https://azure.microsoft.com/en-us/services/event-hubs) states "millions of events per second".

My understanding as to the differences between Service Bus and Event Hub has come in waves of understanding. Here's how I understand it now.

Service Bus (both Queues and Topics) is a bit more of a _managed_ solution. That is, the service is applying some opinion about your solution. Opinions, as you may know, _can_ make a service dramatically easier to implement, but they can also constrain us as solution developers by tying us to specific assumed scenarios.

There are a lot of things that Service Bus does for us that Event Hubs does not attempt to do. It caches datagrams and keeps them for the configured time, but it doesn't decorate them with any status, remember which have been processed, keep track of how many times a datagram has been accessed (_dequeued_ in Service Bus parlance), lock those that have been looked at by any given consumer, or anything like that. It simply stores datagrams in a buffer and if the time runs out on a datagram in the buffer it drops it.

This puts the onus on an Event Hubs consumer to not only read events, but to figure out which ones have been read already.

This lack of management switches us from a pattern called _competing consumer_ to one called _partitioned consumer_. With competing consumers, the service has to spend a bit of time making sure the competition is fair and goes well. With partitioned consumers, there's just a clean rule regarding who gets what. So, if you can assume that there is no competition in your processing then you don't need all the cumbersome status checking, dequeue counting, locking, etc. That's why Event Hubs is super fast.

![](/files/streaming_03.png "competing consumers")

![](/files/streaming_04.png "partitioned consumers")

### Event Grid
Event Grid is newer than both Service Bus and Event Hubs, and it may not be readily apparent what its unique value offering is.

Start by reading Clemens Vaster's excellent article [Events, Data Points, and Messages - Choosing the right Azure messaging service for your data](https://azure.microsoft.com/en-us/blog/events-data-points-and-messages-choosing-the-right-azure-messaging-service-for-your-data/).

Clemens calls Event Grid "event distribution" as opposed to "event streaming". I like that.

Event Grid is a managed Azure platform with deep integration into the whole suite of Azure resources that creates a broad distribution of event publishers and subscribers between Azure services and even into non-Azure services.

Event Grid is not as much of a streaming solution as Event Hubs is. It's highly performant, but it's not tuned for the throughput you would expect to see in an Event Hubs solution.

It's also a bit of a hybrid because it's designed for events, but it has some of the management and features you find in Service Bus like deadlettering and _At Least Once_ delivery.

### Stream Analytics
Together Service Bus, Event Hubs, and Event Grid make up the three primary datagram streaming platform services, but not far behind as far as central streaming services is Stream Analytics. Heck, it even has _Stream_ in the name.

Stream Analytics uses SQL query syntax (modified to add certain streaming semantics like windowing) to analyze data as it's moving.

Think about being tasked with counting the number of red Volkswagon vehicles that pass by some point on the highway. One crude approach would be to ask vehicles to pull over until a large parking lot were full, then perform the analysis, and then let those cars go while bringing new ones in. The obvious impact to traffic is analogous to the performance impact on a digital project - horrendous.

The better way is let the cars go and just count them up as they move unfettered. This is what Stream Analytics attempts to do.


## Appendix A - Other Mentionable Azure Data Services
There are a few other services in Azure that have more distant relationships to the concept of data streaming.

Data services and the often-nuanced differences between one another get truly dizzying. I have so much respect for a data expert's ability to simply choose the right product for a given solution.

I have to mention **IoT Edge** and **IoT Hub**. In the wise words of [Bret Stateham](https://twitter.com/bretstateham) "IoT is a data problem waiting to happen". IoT Hub has an Event Hub endpoint that allows it to integrate with other data services in Azure.

**Data Lake** is a great place to pump all of your structured or unstructured data to figure out what you'll do with it next. A data _lake_ is what you find at the end of a data _stream_ - just like IRL!

**Databricks** gives you the easiest Apache Spark cluster ever. With it you get a convenient notebook interface so you can collaborate and iterate on your data analysis strategies. Databricks is certainly a streaming solution, so if you're wondering why I didn't compare it more directly next Service Bus and Event Hub, it's simply because it's a very different beast and frankly I'm not overly familiar with it.

**Power BI** is a business intelligence platform for visualizing data back to humans so that key decisions can be made. It's worth a mention because it's capable of receiving data streams and even updating visuals in near real-time.

When your data has been ingested, stored, analyzed, and trained, you drop it into **SQL Data Warehouse** - a column store database for big data analysis. Not much streaming at play at this stage of the solution, but it's worth a mention.


latency
    link to the other blog post about measuring latency